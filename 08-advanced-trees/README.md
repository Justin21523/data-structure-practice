# 第八章：進階樹結構（Advanced Tree Structures）

本章介紹幾種重要的進階樹結構，它們在資料庫系統、競賽程式設計等領域有廣泛應用。

## 學習目標

- 理解 B-Tree 系列在磁碟存取優化中的角色
- 掌握區間查詢相關的樹結構
- 學會針對不同問題選擇適當的樹結構

## 單元列表

| 單元 | 主題 | 說明 |
|------|------|------|
| 01 | [B 樹](./01-b-tree/) | 多路平衡搜尋樹 |
| 02 | [B+ 樹](./02-b-plus-tree/) | 資料庫索引結構 |
| 03 | [線段樹](./03-segment-tree/) | 區間查詢與更新 |
| 04 | [樹狀數組](./04-fenwick-tree/) | Binary Indexed Tree |

## B-Tree 系列

### B-Tree

一種自平衡的多路搜尋樹，專為磁碟存取優化設計。

**性質**（度數 t ≥ 2）：
1. 每個節點最多有 2t-1 個鍵
2. 每個節點最少有 t-1 個鍵（根除外）
3. 所有葉節點在同一層
4. 節點有 n 個鍵，則有 n+1 個子節點

```
B-Tree (t=2) 範例:

        [10, 20]
       /    |    \
   [5,7] [15,18] [25,30,40]
```

### B+ Tree

B-Tree 的變體，資料庫系統常用。

**與 B-Tree 的差異**：
| 特性 | B-Tree | B+ Tree |
|------|--------|---------|
| 資料存放 | 所有節點 | 僅葉節點 |
| 葉節點連結 | 無 | 有（方便範圍查詢） |
| 內部節點 | 存鍵和資料 | 僅存索引鍵 |

```
B+ Tree 範例:

        [10, 20]           ← 內部節點（只有鍵）
       /    |    \
   [3,5,7] → [10,15,18] → [20,25,30]  ← 葉節點（鍵+資料）
```

### 操作複雜度

| 操作 | 時間複雜度 |
|------|-----------|
| 搜尋 | O(log_t n) |
| 插入 | O(log_t n) |
| 刪除 | O(log_t n) |

## 區間查詢結構

### 線段樹（Segment Tree）

用於解決區間查詢與區間更新問題。

```
陣列: [2, 1, 5, 3, 4]

線段樹:
              [0,4]=15
             /        \
        [0,2]=8      [3,4]=7
        /    \        /    \
    [0,1]=3 [2,2]=5 [3,3]=3 [4,4]=4
    /    \
 [0]=2  [1]=1
```

**支援操作**：
| 操作 | 時間複雜度 |
|------|-----------|
| 建樹（build） | O(n) |
| 區間查詢（query） | O(log n) |
| 單點更新（update） | O(log n) |
| 區間更新（lazy） | O(log n) |

**應用場景**：
- 區間最大/最小值
- 區間和
- 區間 GCD
- 區間更新（配合 lazy propagation）

### 樹狀數組（Fenwick Tree / Binary Indexed Tree）

比線段樹更簡潔的結構，適合前綴和查詢。

```
原陣列:     [1, 2, 3, 4, 5, 6, 7, 8]
BIT 陣列:   [_, 1, 3, 3, 10, 5, 11, 7, 36]
            (index 0 不用)
```

**核心操作**：
| 操作 | 說明 | 時間複雜度 |
|------|------|-----------|
| update(i, delta) | 單點更新 | O(log n) |
| query(i) | 前綴和 [1, i] | O(log n) |
| rangeQuery(l, r) | 區間和 [l, r] | O(log n) |

**優勢**：
- 實作簡單（比線段樹簡潔）
- 空間效率高（O(n)）
- 常數因子小

**限制**：
- 主要用於可逆運算（如加法、XOR）
- 區間更新需要差分技巧

## 比較總結

| 結構 | 主要用途 | 空間 | 特點 |
|------|---------|------|------|
| B-Tree | 磁碟索引 | O(n) | 最少化磁碟 I/O |
| B+ Tree | 資料庫索引 | O(n) | 範圍查詢優化 |
| Segment Tree | 區間操作 | O(4n) | 彈性高、支援 lazy |
| Fenwick Tree | 前綴和 | O(n) | 實作簡單、常數小 |

## 考試重點

1. **B-Tree / B+ Tree**
   - 插入、刪除過程的分裂與合併
   - B+ Tree 與 B-Tree 的比較
   - 在資料庫中的應用

2. **線段樹**
   - 建樹過程
   - 區間查詢的實作
   - Lazy propagation 的概念

3. **樹狀數組**
   - lowbit 運算的意義
   - 單點更新與前綴查詢
   - 與線段樹的比較

## 延伸閱讀

- CLRS Chapter 18: B-Trees
- 競賽程式設計相關書籍的線段樹章節
